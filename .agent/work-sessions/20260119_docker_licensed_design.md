---
title: Docker Licensed 設計書
description: GitHub licensed ツールをDockerコンテナで実行するための統合設計文書
---

## 1. システム概要

## 背景と目的

本システムは、GitHub社が提供するオープンソースツール「licensed」をDocker環境で実行するためのコンテナ環境です。licensedは、プロジェクトの依存ライブラリのライセンス情報を収集・管理するツールであり、ライセンスコンプライアンスの確保に利用されます。

## 解決する課題

- **環境依存性の排除**: licensedおよびその依存関係（Ruby、Git、各種ネイティブライブラリ）のインストールを簡素化
- **再現性の保証**: 異なる環境でも同一の動作を保証
- **プライベートリポジトリ対応**: GitHub CLIを統合し、認証が必要なリポジトリへのアクセスを可能に
- **Go言語プロジェクト対応**: Go言語で書かれたプロジェクトの依存関係解析をサポート

## スコープ

本システムは以下を提供します：

- licensedツール（バージョン4.4.0）の実行環境
- GitHub CLI（gh）による認証機能
- Go言語ツールチェーン（バージョン1.23.8）
- マルチアーキテクチャサポート（AMD64、ARM64）
- 非rootユーザーでの実行によるセキュリティ強化

## 2. アーキテクチャ設計

## コンテナ構成

本システムは、マルチステージビルドを採用した単一Dockerイメージで構成されます。

### ビルドステージとランタイムステージの分離

| ステージ | ベースイメージ | 役割                             |
| -------- | -------------- | -------------------------------- |
| Builder  | ruby:3.2-slim  | licensedとネイティブ拡張のビルド |
| Runtime  | ruby:3.2-slim  | 軽量な実行環境の提供             |

この分離により、最終イメージからビルドツール（gcc、make、cmake等）を除外し、イメージサイズの削減とセキュリティリスクの低減を実現しています。

## 主要コンポーネント

| コンポーネント  | バージョン | 役割                                       |
| --------------- | ---------- | ------------------------------------------ |
| Ruby            | 3.2        | licensed実行の基盤言語                     |
| licensed gem    | 4.4.0      | ライセンス情報の収集・管理                 |
| GitHub CLI (gh) | 最新版     | プライベートリポジトリへの認証付きアクセス |
| Go toolchain    | 1.23.8     | Goプロジェクトの依存関係解析               |
| Git             | 最新版     | リポジトリ操作の基盤                       |

## データフロー

1. **コンテナ起動**: ホストのプロジェクトディレクトリをコンテナ内にマウント
2. **認証（必要に応じて）**: GitHub CLIによる認証情報の利用
3. **依存関係スキャン**: licensedがプロジェクトの依存関係を解析
4. **ライセンス情報収集**: 各依存ライブラリのライセンス情報を取得
5. **結果出力**: ライセンス情報のキャッシュまたはステータス表示

## 3. 技術的な決定事項

## マルチステージビルドの採用

**決定**: ビルドステージと実行ステージを分離

**理由**:

- ビルドツール（gcc、make、cmake等）を最終イメージから除外し、イメージサイズを削減
- セキュリティリスクの低減（不要なツールの除外）
- ビルド時のみ必要な開発用ライブラリを排除

**代替案**: シングルステージビルドは検討されましたが、イメージサイズとセキュリティ面で劣ります。

## アーキテクチャの動的検出

**決定**: CPU アーキテクチャ（AMD64/ARM64）の動的検出とGoバイナリの選択

**理由**:

- Apple Siliconマシン（ARM64）とIntel/AMD マシン（AMD64）の両方で動作可能
- ビルド時にアーキテクチャを判定し、適切なGoバイナリを自動選択
- ユーザーは環境を意識せずに利用可能

## Ruby 3.2の採用

**決定**: Ruby 3.2をベースイメージとして使用

**理由**:

- licensed gem 4.4.0が要求するRubyバージョンとの互換性
- 安定版でありセキュリティパッチが提供される
- slim バリアントによる軽量化

## GitHub CLIの統合

**決定**: GitHub CLI（gh）を実行環境に含める

**理由**:

- プライベートリポジトリへのアクセスに必要な認証機能を提供
- licensedがプライベート依存関係を解析する際に必須
- 公式リポジトリからの安全なインストール方法を採用

## Goツールチェーンの統合

**決定**: Go 1.23.8を実行環境に含める

**理由**:

- Go言語で書かれたプロジェクトの依存関係解析に必要
- licensedがGo modulesを処理するために必須
- 特定バージョンを固定することで再現性を確保

## 4. 依存関係とライブラリ

## ビルド時依存関係

以下のパッケージは、ビルドステージでのみ必要です：

| パッケージ      | 目的                                             |
| --------------- | ------------------------------------------------ |
| build-essential | C/C++コンパイラ、makeなどの基本ビルドツール      |
| cmake           | rugged gemのネイティブ拡張ビルドに必要           |
| pkg-config      | ライブラリ検出ツール                             |
| libssl-dev      | OpenSSL開発ヘッダー                              |
| zlib1g-dev      | 圧縮ライブラリ開発ヘッダー                       |
| libzstd-dev     | Zstandard圧縮ライブラリ（libgit2のリンクに必須） |
| libssh2-1-dev   | SSH2プロトコルライブラリ開発ヘッダー             |

## ランタイム依存関係

以下のパッケージは、実行時に必要です：

| パッケージ   | 目的                                    |
| ------------ | --------------------------------------- |
| git          | リポジトリ操作                          |
| libssl3t64   | OpenSSLランタイムライブラリ             |
| libssh2-1t64 | SSH2プロトコルランタイムライブラリ      |
| libzstd1     | Zstandard圧縮ランタイムライブラリ       |
| curl, wget   | ファイルダウンロード                    |
| gnupg        | GPG鍵の検証（GitHub CLIインストール用） |

## 重要な依存関係の解説

### libzstd（Zstandard圧縮ライブラリ）

licensedが依存するrugged gemは、内部的にlibgit2を使用します。libgit2はZstandard圧縮をサポートしており、libzstdへのリンクが必要です。

**課題**: 初期実装では libzstd が欠落しており、rugged gemのネイティブ拡張のビルドに失敗

**解決策**:

- ビルドステージに libzstd-dev を追加
- ランタイムステージに libzstd1 を追加

### パッケージ命名規則

Debian系ディストリビューションでは、ライブラリパッケージの命名に注意が必要です：

- **開発パッケージ**: サフィックス（例: libzstd-dev）
- **ランタイムパッケージ**: バージョン番号またはサフィックスなし（例: libzstd1）
- **t64サフィックス**: 一部のパッケージは time_t 64-bit 移行に伴い サフィックスを持つ（例: libssl3t64）

## Ruby Gemの依存関係

| Gem      | バージョン | 目的                                             |
| -------- | ---------- | ------------------------------------------------ |
| licensed | 4.4.0      | メインツール                                     |
| rugged   | -          | libgit2のRubyバインディング（licensedの依存gem） |

## 5. セキュリティ考慮事項

## 非rootユーザーでの実行

**実装**: コンテナ内で appuser という非rootユーザーを作成し、そのユーザーで licensed を実行

**目的**:

- コンテナからのエスケープ攻撃のリスクを軽減
- ホストシステムへの影響を最小化
- セキュリティベストプラクティスに準拠

## 読み取り専用マウント

**推奨設定**: プロジェクトディレクトリを読み取り専用でマウント

**理由**:

- 意図しないファイル変更を防止
- licensed は基本的に読み取り専用アクセスのみ必要（キャッシュファイルを除く）

**注意**: ライセンスキャッシュを作成する場合は、書き込み権限が必要

## イメージサイズの最小化

**手法**:

- マルチステージビルドによる不要なビルドツールの除外
- slim バリアントのベースイメージを使用
- パッケージインストール後のキャッシュクリーンアップ

**効果**:

- 攻撃対象領域の削減
- 脆弱性を持つパッケージの数を最小化

## 依存関係の固定

**方針**: メジャーバージョンを固定

| コンポーネント | バージョン管理                   |
| -------------- | -------------------------------- |
| licensed gem   | 4.4.0（完全固定）                |
| Go toolchain   | 1.23.8（完全固定）               |
| Ruby           | 3.2（マイナー固定）              |
| GitHub CLI     | 最新版（公式リポジトリから取得） |

**理由**:

- 再現性の確保
- 意図しない破壊的変更の回避
- セキュリティアップデートは手動で検証後に適用

## 公式リポジトリの使用

**方針**: GitHub CLI等の外部ツールは公式リポジトリから取得

**実装**:

- GitHub公式のAPTリポジトリを使用
- GPG鍵による署名検証
- 非公式ソースからのダウンロードを回避

## 機密情報の取り扱い

**GitHub認証情報**:

- コンテナイメージには認証情報を含めない
- 実行時にホストの認証情報を利用（ボリュームマウントまたは環境変数）
- GitHub CLIの標準的な認証フローに依存

## 6. 使用方法

## 基本的なワークフロー

### イメージのビルド

コンテナイメージを作成します。初回のみ実行が必要です。

```bash
docker-compose build
```

### licensed の初期化

プロジェクトディレクトリで licensed の設定を初期化します。

```bash
docker-compose run licensed licensed init
```

### ライセンス情報のキャッシュ

依存関係のライセンス情報を収集してキャッシュします。

```bash
docker-compose run licensed licensed cache
```

### ライセンスステータスの確認

ライセンスの変更や問題を検出します。

```bash
docker-compose run licensed licensed status
```

## プライベートリポジトリへのアクセス

GitHub CLI を使用して認証が必要なリポジトリにアクセスする場合：

1. ホストマシンで GitHub CLI の認証を完了
2. 認証情報をコンテナと共有するよう設定
3. licensed 実行時に認証情報が自動的に使用される

## Docker Compose を使わない実行

```bash
# イメージのビルド
docker build -t docker-licensed .

# 実行例
docker run --rm -v $(pwd):/app -w /app docker-licensed licensed status
```

## 設定のカスタマイズ

licensed の動作は .licensed.yml ファイルでカスタマイズ可能です：

- 対象とするソースタイプ（bundler、npm、go等）の指定
- ライセンスの許可リスト・拒否リスト
- 除外パターンの設定

詳細は licensed 公式ドキュメントを参照してください。

## 7. トラブルシューティング

## ビルドエラー: rugged gem のネイティブ拡張ビルド失敗

**症状**: licensed gem インストール時に rugged gem のビルドが失敗

**原因**: libzstd ライブラリが不足している

**解決策**: libzstd-dev がビルドステージに含まれていることを確認

## 実行エラー: 共有ライブラリが見つからない

**症状**: コンテナ実行時に「共有ライブラリが見つからない」というエラー

**原因**: ランタイムに必要なライブラリがインストールされていない

**解決策**: libzstd1、libssl3t64、libssh2-1t64 等のランタイムライブラリが含まれていることを確認

## アーキテクチャ非互換エラー

**症状**: ARM64マシンで「exec format error」が発生

**原因**: Go バイナリのアーキテクチャが環境と一致していない

**解決策**: Dockerfile内のアーキテクチャ検出ロジックが正しく動作していることを確認

## プライベートリポジトリへのアクセスエラー

**症状**: licensed がプライベート依存関係にアクセスできない

**考えられる原因**:

- GitHub CLI の認証が完了していない
- 認証情報がコンテナに共有されていない

**解決策**:

- ホストで `gh auth status` を実行し、認証状態を確認
- 認証情報をコンテナにマウントするか、環境変数で渡す

## Go プロジェクトの解析失敗

**症状**: Go言語プロジェクトの依存関係が検出されない

**考えられる原因**:

- Go toolchain がパスに含まれていない
- GOPATH が正しく設定されていない

**解決策**:

- コンテナ内で `go version` を実行し、Goが利用可能か確認
- 環境変数 PATH、GOPATH が正しく設定されていることを確認

## パーミッションエラー

**症状**: ライセンスキャッシュの作成時にパーミッションエラーが発生

**原因**: 非rootユーザーとホストのユーザーIDが一致せず、ファイル作成権限がない

**解決策**:

- ボリュームマウント先のディレクトリに書き込み権限があることを確認
- 必要に応じてコンテナ内ユーザーのUIDをホストユーザーに合わせる
